<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Registro de Atendimentos</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      margin-top: 25px;
    }
    th, td {
      padding: 12px 15px;
      text-align: center;
      border-bottom: 1px solid #ddd;
    }
    th {
      background-color: #009999;
      color: white;
    }
    tr:hover { background-color: #f5f5f5; }

    button {
      background-color: #007777;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 8px 15px;
      cursor: pointer;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Registro de Atendimentos</h1>

    <label for="pacienteSelect">Selecione o paciente:</label>
    <select id="pacienteSelect"></select>

    <label for="dataAtendimento">Data do atendimento:</label>
    <input type="date" id="dataAtendimento" />

    <label for="procedimento">Procedimento realizado:</label>
    <textarea id="procedimento" rows="3"></textarea>

    <label for="obsAtendimento">Observações:</label>
    <textarea id="obsAtendimento" rows="3"></textarea>

    <button onclick="salvarAtendimento()">Salvar atendimento</button>

    <h3>Histórico de Atendimentos</h3>
    <table id="tabelaAtendimentos">
      <thead>
        <tr>
          <th>Data</th>
          <th>Procedimento</th>
          <th>Observações</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <a href="pacientes.html">Voltar</a>
  </div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const pacienteId = urlParams.get('id');

    async function carregarPacientes() {
      const res = await fetch("/api/pacientes");
      const pacientes = await res.json();
      const select = document.getElementById("pacienteSelect");
      select.innerHTML = '<option value="">Selecione...</option>';
      pacientes.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p.id;
        opt.textContent = p.nome;
        select.appendChild(opt);
      });

      if (pacienteId) {
        select.value = pacienteId;
        carregarAtendimentos(pacienteId);
      }
    }

    async function carregarAtendimentos(pacienteId) {
      if (!pacienteId) return;
      const res = await fetch(`/api/atendimentos/${pacienteId}`);
      const atendimentos = await res.json();
      const tbody = document.querySelector("#tabelaAtendimentos tbody");
      tbody.innerHTML = "";
      atendimentos.forEach(a => {
        const tr = document.createElement("tr");
        const data = new Date(a.data_atendimento).toLocaleDateString("pt-BR");
        tr.innerHTML = `
          <td>${data}</td>
          <td>${a.procedimento}</td>
          <td>${a.observacoes || ""}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function salvarAtendimento() {
      const paciente_id = document.getElementById("pacienteSelect").value;
      const data_atendimento = document.getElementById("dataAtendimento").value;
      const procedimento = document.getElementById("procedimento").value;
      const observacoes = document.getElementById("obsAtendimento").value;

      if (!paciente_id || !data_atendimento || !procedimento) {
        alert("Preencha os campos obrigatórios!");
        return;
      }

      const res = await fetch("/api/atendimentos", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ paciente_id, data_atendimento, procedimento, observacoes })
      });

      if (res.ok) {
        alert("Atendimento salvo!");
        carregarAtendimentos(paciente_id);
      } else {
        alert("Erro ao salvar atendimento!");
      }
    }

    document.getElementById("pacienteSelect").addEventListener("change", e => {
      carregarAtendimentos(e.target.value);
    });

    carregarPacientes();
  </script>
</body>
</html>
